
<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<style>
			body {
				background: black;
				color: rgb(80, 80, 80);
			}
			body, pre, #legend span {
				font-family: Menlo, monospace;
				font-weight: bold;
			}
			#topbar {
				background: black;
				position: fixed;
				top: 0; left: 0; right: 0;
				height: 42px;
				border-bottom: 1px solid rgb(80, 80, 80);
			}
			#content {
				margin-top: 50px;
			}
			#nav, #legend {
				float: left;
				margin-left: 10px;
			}
			#legend {
				margin-top: 12px;
			}
			#nav {
				margin-top: 10px;
			}
			#legend span {
				margin: 0 5px;
			}
			.cov0 { color: rgb(192, 0, 0) }
.cov1 { color: rgb(128, 128, 128) }
.cov2 { color: rgb(116, 140, 131) }
.cov3 { color: rgb(104, 152, 134) }
.cov4 { color: rgb(92, 164, 137) }
.cov5 { color: rgb(80, 176, 140) }
.cov6 { color: rgb(68, 188, 143) }
.cov7 { color: rgb(56, 200, 146) }
.cov8 { color: rgb(44, 212, 149) }
.cov9 { color: rgb(32, 224, 152) }
.cov10 { color: rgb(20, 236, 155) }

		</style>
	</head>
	<body>
		<div id="topbar">
			<div id="nav">
				<select id="files">
				
				<option value="file0">socialapi/workers/payment/card.go (0.0%)</option>
				
				<option value="file1">socialapi/workers/payment/customer.go (52.8%)</option>
				
				<option value="file2">socialapi/workers/payment/email.go (80.0%)</option>
				
				<option value="file3">socialapi/workers/payment/plan.go (41.7%)</option>
				
				<option value="file4">socialapi/workers/payment/stripe.go (0.0%)</option>
				
				<option value="file5">socialapi/workers/payment/subscription.go (0.0%)</option>
				
				<option value="file6">socialapi/workers/payment/webhook_handler.go (26.6%)</option>
				
				</select>
			</div>
			<div id="legend">
				<span>not tracked</span>
			
				<span class="cov0">not covered</span>
				<span class="cov8">covered</span>
			
			</div>
		</div>
		<div id="content">
		
		<pre class="file" id="file0" style="display: none">package payment

import (
        "koding/db/mongodb/modelhelper"

        "github.com/stripe/stripe-go"
        "github.com/stripe/stripe-go/card"
        "github.com/stripe/stripe-go/customer"
)

func DeleteCreditCardForGroup(groupName string) (*stripe.Card, error) <span class="cov0" title="0">{

        group, err := modelhelper.GetGroup(groupName)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>

        <span class="cov0" title="0">if group.Payment.Customer.ID == "" </span><span class="cov0" title="0">{
                return nil, ErrCustomerNotExists
        }</span>

        <span class="cov0" title="0">return deleteCreditCard(group.Payment.Customer.ID)</span>
}

func deleteCreditCard(customerID string) (*stripe.Card, error) <span class="cov0" title="0">{
        cus, err := customer.Get(customerID, nil)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>

        <span class="cov0" title="0">params := &amp;stripe.CardParams{Customer: customerID}

        return card.Del(cus.DefaultSource.ID, params)</span>
}
</pre>
		
		<pre class="file" id="file1" style="display: none">package payment

import (
        "errors"
        "fmt"
        "koding/db/mongodb/modelhelper"

        "github.com/stripe/stripe-go"
        "github.com/stripe/stripe-go/customer"
)

var (
        ErrCustomerNotSubscribedToAnyPlans = errors.New("user is not subscribed to any plans")
        ErrCustomerNotExists               = errors.New("user is not created for subscription")
)

func DeleteCustomerForGroup(groupName string) error <span class="cov8" title="1">{
        group, err := modelhelper.GetGroup(groupName)
        if err != nil </span><span class="cov0" title="0">{
                return err
        }</span>

        <span class="cov8" title="1">if group.Payment.Customer.ID == "" </span><span class="cov0" title="0">{
                return ErrCustomerNotExists
        }</span>

        <span class="cov8" title="1">if err := deleteCustomer(group.Payment.Customer.ID); err != nil </span><span class="cov0" title="0">{
                return err
        }</span>

        <span class="cov8" title="1">return modelhelper.UpdateGroupPartial(
                modelhelper.Selector{"_id": group.Id},
                modelhelper.Selector{
                        "$unset": modelhelper.Selector{"payment.customer.id": ""},
                },
        )</span>
}

func UpdateCustomerForGroup(username, groupName string, params *stripe.CustomerParams) (*stripe.Customer, error) <span class="cov0" title="0">{
        group, err := modelhelper.GetGroup(groupName)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>

        <span class="cov0" title="0">if group.Payment.Customer.ID == "" </span><span class="cov0" title="0">{
                return nil, ErrCustomerNotExists
        }</span>

        <span class="cov0" title="0">params, err = populateCustomerParams(username, groupName, params)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>

        <span class="cov0" title="0">return customer.Update(group.Payment.Customer.ID, params)</span>
}

func GetCustomerForGroup(groupName string) (*stripe.Customer, error) <span class="cov0" title="0">{
        group, err := modelhelper.GetGroup(groupName)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>

        <span class="cov0" title="0">if group.Payment.Customer.ID == "" </span><span class="cov0" title="0">{
                return nil, ErrCustomerNotExists
        }</span>

        <span class="cov0" title="0">return customer.Get(group.Payment.Customer.ID, nil)</span>
}

func CreateCustomerForGroup(username, groupName string, req *stripe.CustomerParams) (*stripe.Customer, error) <span class="cov8" title="1">{

        req, err := populateCustomerParams(username, groupName, req)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>

        <span class="cov8" title="1">cus, err := customer.New(req)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>

        <span class="cov8" title="1">group, err := modelhelper.GetGroup(groupName)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>

        <span class="cov8" title="1">if err := modelhelper.UpdateGroupPartial(
                modelhelper.Selector{"_id": group.Id},
                modelhelper.Selector{
                        "$set": modelhelper.Selector{
                                "payment.customer.id": cus.ID,
                        },
                },
        ); err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>

        <span class="cov8" title="1">return cus, nil</span>
}

func deleteCustomer(customerId string) error <span class="cov8" title="1">{
        cus, err := customer.Del(customerId)
        if cus != nil &amp;&amp; cus.Deleted </span><span class="cov8" title="1">{ // if customer is already deleted previously
                return nil
        }</span>

        <span class="cov0" title="0">return err</span>
}

func populateCustomerParams(username, groupName string, req *stripe.CustomerParams) (*stripe.CustomerParams, error) <span class="cov8" title="1">{
        if req == nil </span><span class="cov0" title="0">{
                req = &amp;stripe.CustomerParams{}
        }</span>

        <span class="cov8" title="1">user, err := modelhelper.GetUser(username)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>

        <span class="cov8" title="1">if req.Desc == "" </span><span class="cov8" title="1">{
                req.Desc = fmt.Sprintf("%s team", groupName)
        }</span>
        <span class="cov8" title="1">if req.Email == "" </span><span class="cov8" title="1">{
                req.Email = user.Email
        }</span>

        <span class="cov8" title="1">if req.Params.Meta == nil </span><span class="cov8" title="1">{
                req.Params.Meta = make(map[string]string)
        }</span>
        <span class="cov8" title="1">req.Params.Meta["groupName"] = groupName
        req.Params.Meta["username"] = username

        return req, nil</span>
}
</pre>
		
		<pre class="file" id="file2" style="display: none">package payment

import (
        "errors"
        "fmt"

        "github.com/kr/pretty"
)

type Action int

const (
        SubscriptionCreated Action = iota
        SubscriptionChanged
        SubscriptionDeleted
        PaymentCreated
        PaymentRefunded
        PaymentFailed
)

var EmailSubjects = map[Action]string{
        SubscriptionCreated: "bought a subscription",
        SubscriptionDeleted: "canceled their subscription",
        SubscriptionChanged: "changed their subscription",
        PaymentCreated:      "received an invoice",
        PaymentRefunded:     "received a refuned",
        PaymentFailed:       "failed to pay",
}

var ErrEmailActionNotFound = errors.New("action not found")

func formatCurrency(currencyStr string, amount uint64) string <span class="cov8" title="1">{
        fmt.Printf("currencyStr %# v", pretty.Formatter(currencyStr))
        switch currencyStr </span>{
        <span class="cov8" title="1">case "USD", "usd":
                currencyStr = "$"</span>
        <span class="cov0" title="0">default:
                return ""</span>
        }

        <span class="cov8" title="1">return fmt.Sprintf("%s%v", currencyStr, amount/100)</span>
}
</pre>
		
		<pre class="file" id="file3" style="display: none">package payment

import (
        "socialapi/config"
        "strings"

        stripe "github.com/stripe/stripe-go"
        stripeplan "github.com/stripe/stripe-go/plan"
)

// Up to 10 users:  $49.97 per developer per month
// Up to 50 users:  $39.97 per developer per month
// Over 50 users:  $34.97 per developer per month

const (
        USD = stripe.Currency("USD")
)

// TrialPeriod: Specifies a trial period in (an integer number of) days. If you
// include a trial period, the customer won’t be billed for the first time until
// the trial period ends. If the customer cancels before the trial period is
// over, she’ll never be billed at all.

var Plans = []*stripe.PlanParams{
        // Forever free koding
        &amp;stripe.PlanParams{
                Amount:        0,
                Interval:      stripeplan.Month,
                IntervalCount: 1,
                TrialPeriod:   0,
                Name:          "Free Forever",
                Currency:      USD,
                ID:            "p_free_forever",
                Statement:     "FREE",
        },

        // 7 days free koding
        &amp;stripe.PlanParams{
                Amount:        0,
                Interval:      stripeplan.Week,
                IntervalCount: 1,
                TrialPeriod:   7,
                Name:          "Free For 7 days",
                Currency:      USD,
                ID:            "p_free_for_7_days",
                Statement:     "FREE FOR 7 DAYS",
        },

        // 30 days free koding
        &amp;stripe.PlanParams{
                Amount:        0,
                Interval:      stripeplan.Month,
                IntervalCount: 1,
                TrialPeriod:   30,
                Name:          "Free For 30 days",
                Currency:      USD,
                ID:            "p_free_for_30_days",
                Statement:     "FREE FOR 30 DAYS",
        },

        &amp;stripe.PlanParams{
                Amount:        4997,
                Interval:      stripeplan.Month,
                IntervalCount: 1,
                TrialPeriod:   0,
                Name:          "Up to 10 users",
                Currency:      USD,
                ID:            "p_up_to_10",
                Statement:     "UP TO 10 USERS",
        },
        &amp;stripe.PlanParams{
                Amount:        3997,
                Interval:      stripeplan.Month,
                IntervalCount: 1,
                TrialPeriod:   0,
                Name:          "Up to 50 users",
                Currency:      USD,
                ID:            "p_up_to_50",
                Statement:     "UP TO 50 USERS",
        },
        &amp;stripe.PlanParams{
                Amount:        3497,
                Interval:      stripeplan.Month,
                IntervalCount: 1,
                TrialPeriod:   0,
                Name:          "Over 50 users",
                Currency:      USD,
                ID:            "p_over_50",
                Statement:     "OVER 50 USERS",
        },
}

// CreateDefaultPlans creates predefined default plans. This is meant to be run
// when the worker starts to be sure the plans are there.
func CreateDefaultPlans() error <span class="cov8" title="1">{
        for _, planParams := range Plans </span><span class="cov8" title="1">{
                p, err := stripeplan.Get(planParams.ID, nil)
                if err == nil &amp;&amp; p != nil &amp;&amp; p.ID == planParams.ID </span><span class="cov8" title="1">{
                        continue</span>
                }

                <span class="cov0" title="0">if _, err := stripeplan.New(planParams); err != nil </span><span class="cov0" title="0">{
                        if strings.Contains(err.Error(), "already exists") </span><span class="cov0" title="0">{
                                continue</span>
                        }

                        <span class="cov0" title="0">return err</span>
                }
        }

        <span class="cov8" title="1">return nil</span>
}

func Initialize(conf *config.Config) error <span class="cov0" title="0">{
        stripe.Key = conf.Stripe.SecretToken
        go CreateDefaultPlans() // for now only default plan creation
        return nil
}</span>
</pre>
		
		<pre class="file" id="file4" style="display: none">package payment

import "errors"

type StripeHandler func([]byte) error

var stripeActions = map[string]StripeHandler{
        "charge.succeeded": chargeSucceededHandler,
        "charge.failed":    chargeFailedHandler,

        "customer.subscription.created":        customerSubscriptionCreatedHandler,
        "customer.subscription.deleted":        customerSubscriptionDeletedHandler,
        "customer.subscription.updated":        customerSubscriptionUpdatedHandler,
        "customer.subscription.trial_will_end": customerSubscriptionTrialWillEndHandler,

        "invoice.created":           invoiceCreatedHandler,
        "invoice.payment_failed":    invoicePaymentFailedHandler,
        "invoice.payment_succeeded": invoicePaymentFailedHandler,
}

func GetHandler(name string) (StripeHandler, error) <span class="cov0" title="0">{
        action, ok := stripeActions[name]
        if ok </span><span class="cov0" title="0">{
                return action, nil
        }</span>

        <span class="cov0" title="0">return nil, errors.New("handler not found")</span>
}
</pre>
		
		<pre class="file" id="file5" style="display: none">package payment

import (
        "koding/db/mongodb/modelhelper"

        "github.com/stripe/stripe-go"
        "github.com/stripe/stripe-go/sub"
)

func DeleteSubscriptionForGroup(groupName string) (*stripe.Sub, error) <span class="cov0" title="0">{
        group, err := modelhelper.GetGroup(groupName)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>

        <span class="cov0" title="0">if group.Payment.Subscription.ID == "" </span><span class="cov0" title="0">{
                return nil, ErrCustomerNotSubscribedToAnyPlans
        }</span>

        <span class="cov0" title="0">return sub.Cancel(group.Payment.Subscription.ID, nil)</span>
}

func UpdateSubscriptionForGroup(groupName string, params *stripe.SubParams) (*stripe.Sub, error) <span class="cov0" title="0">{
        group, err := modelhelper.GetGroup(groupName)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>

        <span class="cov0" title="0">if group.Payment.Subscription.ID == "" </span><span class="cov0" title="0">{
                return nil, ErrCustomerNotSubscribedToAnyPlans
        }</span>

        <span class="cov0" title="0">return sub.Cancel(group.Payment.Subscription.ID, nil)</span>
}

func GetSubscriptionForGroup(groupName string) (*stripe.Sub, error) <span class="cov0" title="0">{
        group, err := modelhelper.GetGroup(groupName)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>

        <span class="cov0" title="0">if group.Payment.Subscription.ID == "" </span><span class="cov0" title="0">{
                return nil, ErrCustomerNotSubscribedToAnyPlans
        }</span>

        <span class="cov0" title="0">return sub.Get(group.Payment.Subscription.ID, nil)</span>
}

func CreateSubscriptionForGroup(groupName string, params *stripe.SubParams) (*stripe.Sub, error) <span class="cov0" title="0">{
        group, err := modelhelper.GetGroup(groupName)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>

        <span class="cov0" title="0">sub, err := sub.New(params)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>

        <span class="cov0" title="0">if err := modelhelper.UpdateGroupPartial(
                modelhelper.Selector{"_id": group.Id},
                modelhelper.Selector{
                        "$set": modelhelper.Selector{
                                "payment.subscription.id":     sub.ID,
                                "payment.subscription.status": sub.Status,
                        },
                },
        ); err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>

        <span class="cov0" title="0">return sub, nil</span>
}
</pre>
		
		<pre class="file" id="file6" style="display: none">package payment

import (
        "encoding/json"
        "fmt"
        "koding/db/mongodb/modelhelper"
        "socialapi/workers/email/emailsender"

        "github.com/kr/pretty"
        "github.com/stripe/stripe-go"
        "github.com/stripe/stripe-go/customer"
)

var mailSender = emailsender.Send

func chargeSucceededHandler(raw []byte) error <span class="cov8" title="1">{
        var charge *stripe.Charge

        err := json.Unmarshal(raw, &amp;charge)
        if err != nil </span><span class="cov0" title="0">{
                return err
        }</span>

        <span class="cov8" title="1">opts := getAmountOpts(charge)
        eventName := "charge succeeded"

        return sendEventForCustomer(charge.Customer.ID, eventName, opts)</span>
}

func chargeFailedHandler(raw []byte) error <span class="cov8" title="1">{
        var charge *stripe.Charge

        err := json.Unmarshal(raw, &amp;charge)
        if err != nil </span><span class="cov0" title="0">{
                return err
        }</span>

        <span class="cov8" title="1">opts := getAmountOpts(charge)
        eventName := "charge failed"

        return sendEventForCustomer(charge.Customer.ID, eventName, opts)</span>
}

func getAmountOpts(charge *stripe.Charge) map[string]interface{} <span class="cov8" title="1">{
        amount := formatCurrency(string(charge.Currency), charge.Amount)
        return map[string]interface{}{"amount": amount}
}</span>

func customerSubscriptionCreatedHandler(raw []byte) error <span class="cov0" title="0">{
        var req *stripe.Sub

        err := json.Unmarshal(raw, &amp;req)
        if err != nil </span><span class="cov0" title="0">{
                return err
        }</span>

        <span class="cov0" title="0">eventName := fmt.Sprintf("subscribed to %s plan", req.Plan.ID)

        return sendEventForCustomer(req.Customer.ID, eventName, nil)</span>
}

func customerSubscriptionDeletedHandler(raw []byte) error <span class="cov0" title="0">{
        var req *stripe.Sub

        err := json.Unmarshal(raw, &amp;req)
        if err != nil </span><span class="cov0" title="0">{
                return err
        }</span>

        <span class="cov0" title="0">eventName := fmt.Sprintf("unsubscribed from %s plan", req.Plan.ID)

        return sendEventForCustomer(req.Customer.ID, eventName, nil)</span>
}

func customerSubscriptionUpdatedHandler(raw []byte) error <span class="cov0" title="0">{
        var req *stripe.Sub

        err := json.Unmarshal(raw, &amp;req)
        if err != nil </span><span class="cov0" title="0">{
                return err
        }</span>

        <span class="cov0" title="0">eventName := fmt.Sprintf("subscription of %s plan updated", req.Plan.ID)

        return sendEventForCustomer(req.Customer.ID, eventName, nil)</span>
}

func customerSubscriptionTrialWillEndHandler(raw []byte) error <span class="cov0" title="0">{
        var req *stripe.Sub

        err := json.Unmarshal(raw, &amp;req)
        if err != nil </span><span class="cov0" title="0">{
                return err
        }</span>

        <span class="cov0" title="0">eventName := fmt.Sprintf("trial of %s plan subscription will end", req.Plan.ID)

        return sendEventForCustomer(req.Customer.ID, eventName, nil)</span>
}

func invoiceCreatedHandler(raw []byte) error <span class="cov0" title="0">{
        var invoice *stripe.Invoice

        err := json.Unmarshal(raw, &amp;invoice)
        if err != nil </span><span class="cov0" title="0">{
                return err
        }</span>

        <span class="cov0" title="0">return nil</span>
}

func invoicePaymentFailedHandler(raw []byte) error <span class="cov0" title="0">{
        var invoice *stripe.Invoice

        err := json.Unmarshal(raw, &amp;invoice)
        if err != nil </span><span class="cov0" title="0">{
                return err
        }</span>

        <span class="cov0" title="0">return handleInvoiceStateChange(invoice)</span>
}

func invoicePaymentSucceededHandler(raw []byte) error <span class="cov0" title="0">{
        var invoice *stripe.Invoice

        err := json.Unmarshal(raw, &amp;invoice)
        if err != nil </span><span class="cov0" title="0">{
                return err
        }</span>

        <span class="cov0" title="0">return handleInvoiceStateChange(invoice)</span>
}

func handleInvoiceStateChange(invoice *stripe.Invoice) error <span class="cov0" title="0">{
        cus, err := customer.Get(invoice.Customer.ID, nil)
        if err != nil </span><span class="cov0" title="0">{
                return err
        }</span>

        <span class="cov0" title="0">if cus.Subs.Count != 1 </span><span class="cov0" title="0">{
                fmt.Printf("customer should only have one sub %# v", pretty.Formatter(cus))
                // TODO CRITICAL
                return nil
        }</span>

        <span class="cov0" title="0">status := cus.Subs.Values[0].Status

        // state :=
        groupName := cus.Meta["groupName"]

        group, err := modelhelper.GetGroup(groupName)
        if err != nil </span><span class="cov0" title="0">{
                return err
        }</span>

        <span class="cov0" title="0">if err := modelhelper.UpdateGroupPartial(
                modelhelper.Selector{"_id": group.Id},
                modelhelper.Selector{
                        "$set": modelhelper.Selector{
                                "payment.subscription.status": status,
                        },
                },
        ); err != nil </span><span class="cov0" title="0">{
                return err
        }</span>

        <span class="cov0" title="0">eventName := fmt.Sprintf("invoice status changed to %s", status)
        return sendEventForCustomer(invoice.Customer.ID, eventName, nil)</span>
}

func sendEventForCustomer(customerID string, eventName string, options map[string]interface{}) error <span class="cov8" title="1">{
        cus, err := customer.Get(customerID, nil)
        if err != nil </span><span class="cov0" title="0">{
                return err
        }</span>

        <span class="cov8" title="1">if options == nil </span><span class="cov0" title="0">{
                options = make(map[string]interface{})
        }</span>

        <span class="cov8" title="1">for key, val := range cus.Meta </span><span class="cov8" title="1">{
                options[key] = val
        }</span>

        <span class="cov8" title="1">mail := &amp;emailsender.Mail{
                To:      cus.Email,
                Subject: eventName,
                Properties: &amp;emailsender.Properties{
                        Username: cus.Meta["username"],
                        Options:  options,
                },
        }

        return mailSender(mail)</span>
}
</pre>
		
		</div>
	</body>
	<script>
	(function() {
		var files = document.getElementById('files');
		var visible;
		files.addEventListener('change', onChange, false);
		function select(part) {
			if (visible)
				visible.style.display = 'none';
			visible = document.getElementById(part);
			if (!visible)
				return;
			files.value = part;
			visible.style.display = 'block';
			location.hash = part;
		}
		function onChange() {
			select(files.value);
			window.scrollTo(0, 0);
		}
		if (location.hash != "") {
			select(location.hash.substr(1));
		}
		if (!visible) {
			select("file0");
		}
	})();
	</script>
</html>
